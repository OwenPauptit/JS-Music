
<button onclick="startPlaying()">Start</button>

<canvas id="canvas" width="600" height="400"></canvas>

<script src="music.js"></script>
<script src="vector.js"></script>
<script src="vehicle.js"></script>
<script src="ball.js"></script>
<script src="line.js"></script>

<script>

    const context = new AudioContext();
    //const notes = ["C4", "E3", "A4"]//["E5", "D#5", "E5", "D#5", "E5", "B4", "D5", "C5", "A4"]
    //const notes = ["G#3", "C#4", "E3", "G#3", "C#4", "E3", "G#3", "C#4", "E3", "G#3", "C#4", "E3", "G#3", "C#4", "E3", "G#3", "C#4", "E3", "A3", "C#4", "E3", "A3", "C#4", "E3", "A3", "D3", "F#3", "A3", "D3", "F#3"]
    //const notes = ['A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'C5', 'A#4', 'A4', 'A#4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'C5', 'A#4', 'A4', 'A#4', 'A#4', 'G4', 'A#4', 'G4', 'A#4', 'G4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'C5', 'A#4', 'A4', 'A#4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'C5', 'A#4', 'A4', 'A#4', 'A#4', 'G4', 'A#4', 'G4', 'A#4', 'G4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'C5', 'A#4', 'A4', 'A#4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'C5', 'A#4', 'A4', 'A#4', 'A#4', 'G4', 'A#4', 'G4', 'A#4', 'G4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'C5', 'A#4', 'A4', 'A#4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'C5', 'A#4', 'A4', 'A#4', 'A#4', 'G4', 'A#4', 'G4', 'A#4', 'G4', 'A#4', 'G4', 'A#4', 'A4', 'A#4', 'A4', 'A#4', 'A4', 'A#4', 'A4', 'A#4', 'A4', 'A#4', 'A4', 'A#4', 'A4', 'A#4', 'A4', 'A#4', 'A4', 'A#4', 'A4', 'A#4', 'A4', 'G4', 'A#4', 'A#4', 'A#4', 'A4', 'A4', 'A4', 'G4', 'A#4', 'A#4', 'A#4', 'A4', 'A4', 'A4', 'G4', 'G4', 'G4', 'G4', 'A4', 'A4', 'A4', 'A4', 'A#4', 'A#4', 'A#4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'A#4', 'A4', 'G4', 'D4', 'C5', 'A#4', 'A4', 'A#4'];
    //first one: 
    //const notes = ['A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'C4', 'A#3', 'A3', 'A#3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'C4', 'A#3', 'A3', 'A#3', 'A#3', 'G3', 'A#3', 'G3', 'A#3', 'G3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'C4', 'A#3', 'A3', 'A#3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'C4', 'A#3', 'A3', 'A#3', 'A#3', 'G3', 'A#3', 'G3', 'A#3', 'G3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'C4', 'A#3', 'A3', 'A#3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'C4', 'A#3', 'A3', 'A#3', 'A#3', 'G3', 'A#3', 'G3', 'A#3', 'G3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'C4', 'A#3', 'A3', 'A#3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'C4', 'A#3', 'A3', 'A#3', 'A#3', 'G3', 'A#3', 'G3', 'A#3', 'G3', 'A#3', 'G3', 'A#3', 'A3', 'A#3', 'A3', 'A#3', 'A3', 'A#3', 'A3', 'A#3', 'A3', 'A#3', 'A3', 'A#3', 'A3', 'A#3', 'A3', 'A#3', 'A3', 'A#3', 'A3', 'A#3', 'A3', 'G3', 'A#3', 'A#3', 'A#3', 'A3', 'A3', 'A3', 'G3', 'A#3', 'A#3', 'A#3', 'A3', 'A3', 'A3', 'G3', 'G3', 'G3', 'G3', 'A3', 'A3', 'A3', 'A3', 'A#3', 'A#3', 'A#3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'A#3', 'A3', 'G3', 'D3', 'C4', 'A#3', 'A3', 'A#3'];
    //Dance monkey: http://www.mintmusic.co.uk/2020/04/dance-monkey-tones-and-i.html
    //const notes = ['F#3', 'E3', 'F#3', 'E3', 'F#3', 'E3', 'F#3', 'E3', 'F#3', 'A3', 'G#3','', 'A3', 'A3', 'G#3', 'F#3', 'F#3', 'E3', 'F#3', 'E3', 'F#3', 'A3', 'G#3','', 'E3', 'F#3', 'E3', 'F#3', 'E3', 'F#3', 'E3', 'F#3', 'E3', 'F#3', 'A3', 'G#3', 'G#3', 'A3', 'A3', 'G#3', 'F#3', 'F#3', 'E3', 'F#3', 'E3', 'F#3', 'A3', 'G#3'];
    const notes = ['F#4', '', '', '', 'F#4', '', '', '', 'A4', '', 'A4', 'A4', 'G#4', '', 'G#4', 'G#4', 'G#4', '', 'F#4', 'F#4', 'A4', 'A4', '', 'F#4', '', '', '', '', '-', '-', '-', '-','-', '-', '-', 'F#4', 'A4', 'A4', '', 'G#4', '', '', 'G#4', 'F#4', 'G#4', 'F#4', 'G#4', 'F#4', '', 'G#4', '', 'F#4', 'A4', '', 'G#4', '', 'F#4', '', 'A4', '', '-', '-', '-', '-'];


    const oscillator = context.createOscillator();
    const envelope = context.createGain();
    const decayRate = Math.PI/24; // seconds


    let playing = false;

    index = 0;
    //let vehicles = [];
    let t;
    let lines = [];
    let balls = [];

    window.onload = function()
    {
        canvas = document.getElementById("canvas");
        ctx = canvas.getContext("2d");

        //vehicles.push(new Vehicle(200,300,0));
        //vehicles.push(new Vehicle(200,205,1));
        //vehicles.push(new Vehicle(200,250,0));
        t = new Vector(200,200); 
        balls.push(new Ball(200,200,100,theta=0,vdir=-1));
        balls.push(new Ball(200,200,100,theta=Math.PI,vdir=-1));
        balls.push(new Ball(400,200,100,theta=0.01+Math.PI/2,vdir=1));
        balls.push(new Ball(400,200,100,theta=0.01+3*Math.PI/2,vdir=1));

        lines.push(new Line(300,255,440));
        lines.push(new Line(300,220,440));
        lines.push(new Line(300,180,440));
        lines.push(new Line(300,145,440,islast=true));


        var loop = setInterval(gameLoop, 1000/40);
    }

    gameLoop = function()
    {
        console.log(index);
        draw();
        for (var i = 0; i < balls.length; i++)
        {
            balls[i].Update();
            balls[i].Draw(ctx);

            if (playing)
            {
                for (var j = 0; j < lines.length; j++)
                {
                    if (balls[i].pos.y < lines[j].centre.y+10 && balls[i].pos.y > lines[j].centre.y-10)
                    {
                        //console.log(balls[i].pos.x < lines[j].centre.x + 50,balls[i].pos.x > lines[j].centre - 50);
                    
                        if 
                       ( balls[i].pos.x < lines[j].centre.x + 50 && balls[i].pos.x > lines[j].centre.x - 50 &&  balls[i].lastLinePassed != j)
                    {
                            balls[i].lastLinePassed = j;
                            changeNote(j);
                        
                    }
                    }
                }
            }
        }
        for (var i = 0; i < lines.length; i++)
        {
            lines[i].Draw(ctx);
        }


        /*for (var i = 0; i < vehicles.length; i++)
        {
            vehicles[i].Seek(t);
            vehicles[i].Update();
            vehicles[i].Draw(ctx);

            //console.log(vehicles[i].velocity.y);

            if (playing)
            {
                if (Vector.DistanceSquared(vehicles[i].position,t) < 5)
                {
                    changeNote();
                }
        }
        }*/
    }

    startPlaying = function()
    {
        if(!playing)
        {
            playing = true;
            updateLines();

            oscillator.frequency.value = Player.getFrequency(notes[0]);
            oscillator.type = 'sine';
            envelope.gain.value = 1;

            oscillator.connect(envelope);
            envelope.connect(context.destination);  

            oscillator.start(context.currentTime);

        }
    }

    draw = function()
    {
        ctx.fillStyle = "black";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        /*ctx.strokeStyle = "white";
        ctx.beginPath();
        ctx.moveTo(250,200);
        ctx.lineTo(350,200);
        ctx.stroke();*/
    }

    play = function(note)
    {
        frequency = Player.getFrequency(note);
        Player.play(frequency, context);
    }

    changeNote = function(q)
    {
        //if (lines[q].frequency != Infinity)
        //{
            console.log(lines[q].nextFrequency);
            if (lines[q].nextFrequency == 30000)
            {
                envelope.gain.exponentialRampToValueAtTime(0.005, context.currentTime + decayRate/2);
            }
            else if (lines[q].nextFrequency < 10000)
            {
                oscillator.frequency.value = lines[q].nextFrequency;
                envelope.gain.exponentialRampToValueAtTime(0.1, context.currentTime + decayRate);
                envelope.gain.exponentialRampToValueAtTime(0.7, context.currentTime + decayRate/8);
                lines[q].Oscillate();
            }
        //}

        if (lines[q].isLast)
        {
            setTimeout(updateLines(),Math.PI/30);
        }
    }

    updateLines = function()
    {
        for (var k = 0; k < lines.length; k++)
                {
                    index++;
                    if (index == notes.length)
                    {
                        index = 0;
                    }
                    lines[k].ChangeFrequency(Player.getFrequency(notes[index]));
                }
    }

    playFurElise = function()
    {
        play(notes[index]);
        index++;
        if (index == notes.length)
        {
            index = 0;
        }
    }

  
</script>